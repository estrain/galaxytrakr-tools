name: Sync Galaxy Tools to Mercurial Tool Shed

on:
  push:
    branches: [ main ]
    paths:
      - 'tools/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'tools/**'
  workflow_dispatch:

jobs:
  sync-tools:
    name: Sync Updated Mercurial ToolShed Repos
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2   # needed for git diff to see last commit

      - name: Install Mercurial
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y mercurial

      - name: Identify Changed Tool Directories
        id: changes
        run: |
          set -euo pipefail
          echo "Detecting changed Galaxy tools..."
          CHANGED=$(git diff --name-only HEAD^ HEAD | grep '^tools/' || true)
          echo "$CHANGED" | sed 's|/[^/]*$||' | sort -u | uniq > changed_dirs.txt

          if [[ -s changed_dirs.txt ]]; then
            echo "Detected changed tool directories:"
            cat changed_dirs.txt
            echo "tool_dirs=$(paste -sd ' ' changed_dirs.txt)" >> "$GITHUB_OUTPUT"
          else
            echo "No changed tools detected."
            echo "tool_dirs=" >> "$GITHUB_OUTPUT"
          fi

      - name: Sync Tools to Tool Shed
        if: steps.changes.outputs.tool_dirs != ''
        env:
          HG_USER: ${{ secrets.HG_USER }}
          HG_PASS: ${{ secrets.HG_PASS }}
          HG_EMAIL: ${{ secrets.HG_EMAIL }}
        run: |
          set -euo pipefail

          HG_USER="${HG_USER:-estrain}"
          HG_PASS="${HG_PASS:-}"
          HG_EMAIL="${HG_EMAIL:-${HG_USER}@example.com}"
          [[ -z "$HG_PASS" ]] && { echo "Error: HG_PASS not set"; exit 1; }

          HG_BASE_URL="https://${HG_USER}:${HG_PASS}@opentrakr.org/repos/${HG_USER}"

          echo "Starting sync for changed tool repos..."
          for dir in ${{ steps.changes.outputs.tool_dirs }}; do
            TOOL_NAME=$(basename "$dir")
            REPO_URL="${HG_BASE_URL}/${TOOL_NAME}"

            echo ">>> Syncing $TOOL_NAME ..."
            cd "$dir"

            # Check if remote repo exists (skip if 404)
            if ! curl -fs --head "${REPO_URL}" >/dev/null 2>&1; then
              echo "   Skipping $TOOL_NAME â€” remote repo not found."
              cd - >/dev/null
              continue
            fi

            # Ensure remote path and username
            [[ -z "$(hg paths default 2>/dev/null || true)" ]] && \
              printf "[paths]\ndefault = %s\n" "$REPO_URL" >> .hg/hgrc

            [[ -z "$(hg showconfig ui.username 2>/dev/null || true)" ]] && \
              printf "[ui]\nusername = %s <%s>\n" "$HG_USER" "$HG_EMAIL" >> .hg/hgrc

            # Commit + push only if uncommitted changes exist
            if [[ -n "$(hg status)" ]]; then
              echo "   [$TOOL_NAME] committing and pushing changes..."
              hg addremove -q
              hg commit -m "Auto-sync $(date +%Y-%m-%d)" -q || true
              hg push -q || { echo "   Warning: Push failed for $TOOL_NAME"; }
            else
              echo "   [$TOOL_NAME] no local changes to commit"
            fi

            cd - >/dev/null
          done

          echo "All changed Mercurial tool repositories synchronized successfully."

